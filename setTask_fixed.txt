const setTask = async (taskId: string | null) => {
    // Save time to current task before switching or deselecting
    if (currentTaskId && currentTaskId !== taskId) {
      const timeSpent = time - taskStartTimeRef.current;
      if (timeSpent > 0) {
        const { data: task } = await supabase
          .from('tasks')
          .select('total_time_spent_ms')
          .eq('id', currentTaskId)
          .single();
        
        if (task) {
          await supabase
            .from('tasks')
            .update({ total_time_spent_ms: task.total_time_spent_ms + timeSpent })
            .eq('id', currentTaskId);
          
          // Dispatch event for optimistic UI update
          window.dispatchEvent(new CustomEvent('task-time-updated', { 
            detail: { taskId: currentTaskId, newTime: task.total_time_spent_ms + timeSpent } 
          }));
        }
      }
    }
    
    // Set task start time reference for new task
    if (taskId) {
      // When selecting a task, set the start time to current stopwatch time
      taskStartTimeRef.current = time;
    }
    
    // Update task reference
    await syncState({ taskId });
    setCurrentTaskId(taskId);
  };
